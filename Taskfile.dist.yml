version: '3'

tasks:
  gen-go-protos:
    desc: generate go protobuf bits
    cmds:
    - protoc -I./protos/ --go_out=mixerserver/protos/ --go_opt=paths=source_relative --go-grpc_out=mixerserver/protos/ --go-grpc_opt=paths=source_relative protos/*.proto

  gen-dart-protos:
    desc: generate dart protobuf bits
    cmds:
    - protoc -I./protos/ --dart_out=mixer/lib/protos protos/*.proto

  protos:
    desc: generate protobuf bits
    cmds:
    - task: gen-go-protos
    - task: gen-dart-protos

  make-migration:
    desc: create a DB migration, requires name as argument
    dir: mixerserver/internal/storage/migrations
    cmds:
    - migrate create -ext sql {{ .CLI_ARGS }}

  build-server-binary:
    desc: build the mixerserver binary locally
    dir: mixerserver
    cmds:
    - go build -o mixerserver

  compose-supporting:
    desc: start up supporting docker compose infrastructure
    dir: mixerserver
    cmds:
    - docker-compose up -d --wait postgres

  compose-down:
    desc: bring down compose stack
    dir: mixerserver
    cmds:
    - docker-compose down --volumes

  migrate:
    desc: execute migrations against a running postgres
    dir: mixerserver
    cmds:
    - task: build-server-binary
    - ./mixerserver migrate

  psql:
    desc: psql to running postgres
    cmds:
    - PGPASSWORD=mixer_pass psql -h localhost -U mixer_usr mixer

  bob-generate:
    desc: run bob code generation
    dir: mixerserver
    cmds:
    - go run github.com/stephenafamo/bob/gen/bobgen-psql@latest

  local:
    desc: run mixer locally
    dir: mixerserver
    cmds:
    - task: build-server-binary
    - ./mixerserver
