vars:
  service: "localhost:50051"
  drink_service: "mixer.DrinkService"
  user_service: "mixer.UserService"

calls:
- name: login baz
  type: grpc
  service-host: '{{ .service }}'
  url: '{{ .user_service }}/Login'
  body:
    username: baz
    password: bazpass
  exports:
  - jq: '.accessToken'
    as: 'baz_token'

- name: create public drink one
  type: grpc
  headers:
    authorization: '{{ .baz_token }}'
  service-host: '{{ .service }}'
  url: '{{ .drink_service }}/CreateDrink'
  body:
    drink_data:
      name: Public Drink One
      primary_alcohol: Rum
      ingredients: ["2.5 oz Rum"]
      publicity: 1

- name: create public drink two
  type: grpc
  headers:
    authorization: '{{ .baz_token }}'
  service-host: '{{ .service }}'
  url: '{{ .drink_service }}/CreateDrink'
  body:
    drink_data:
      name: Public Drink Two
      primary_alcohol: Rum
      ingredients: ["2.5 oz Rum"]
      publicity: 1

- name: create private drink
  type: grpc
  headers:
    authorization: '{{ .baz_token }}'
  service-host: '{{ .service }}'
  url: '{{ .drink_service }}/CreateDrink'
  body:
    drink_data:
      name: Private Drink One
      primary_alcohol: Rum
      ingredients: ["2.5 oz Rum"]
      publicity: 2

- name: login foo
  type: grpc
  service-host: '{{ .service }}'
  url: '{{ .user_service }}/Login'
  body:
    username: foo
    password: foopass
  exports:
  - jq: '.accessToken'
    as: 'foo_token'

- name: list baz drinks as foo
  type: grpc
  headers:
    authorization: '{{ .foo_token }}'
  service-host: '{{ .service }}'
  url: '{{ .drink_service }}/ListDrinks'
  body:
    username: baz
  asserts:
  - jq: '.drinks | [.[] | .drinkData.name]'
    expected:
    - Public Drink One
    - Public Drink Two

- name: list baz drinks as baz
  type: grpc
  headers:
    authorization: '{{ .baz_token }}'
  service-host: '{{ .service }}'
  url: '{{ .drink_service }}/ListDrinks'
  body:
    username: baz
  asserts:
  - jq: '.drinks | [.[] | .drinkData.name]'
    expected:
    - Public Drink One
    - Public Drink Two
    - Private Drink One
